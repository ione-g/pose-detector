# Визначення поз (Pose Detector)

**Pose Detector** — це Python-проєкт для вилучення та аналізу послідовностей людських поз із відео. Він використовує MediaPipe Pose для визначення суглобів, PyTorch для побудови моделей глибокого навчання та набір утиліт для підготовки датасетів, навчання моделей та запуску інференсу. Основна ідея полягає в перетворенні RGB-відео в послідовності скелетів із 33 точок, побудові ковзних вікон та навчанні графової згорткової мережі (ST-GCN) для розпізнавання різних рухів.

---
## Автор
- **ПІБ**: Грималюк Іван Іванович
- **Група**: ФЕІм-21
- **Керівник**: Вельгош Сергій Романович, кандидат фізико-математичних наук, доцент кафедри радіофізики та комп’ютерних технологій, заступник декана факультету електроніки та комп'ютерних технологій з наукової і навчально-виховної роботи
- **Дата виконання**: [02.12.2025]

---


- **Назва**: Pose Detector
- **Тип проєкту**: Система класифікації фізичних вправ на основі 3D-позицій людського скелету
- **Мови програмування**: Python
- **Основні фреймворки та бібліотеки**: MediaPipe BlazePose, PyTorch
- **Модель**: ST-GCN (Spatial-Temporal Graph Convolutional Network)

---

## Можливості

- **Витягування поз із відео** — `mediapipe_layer/extractor.py`  читає відеофайл, визначає 33 суглоби в кожному кадрі та зберігає результат у файл `.npz` розміром `(T,33,4)`,що містить `(x, y, z, visibility)` разом з JSON‑файлом із метаданими, який зберігає частоту кадрів та інші параметри. Інтерфейс командного рядка дозволяє вибрати складність моделі, мінімальну впевненість виявлення та відстеження, параметри згладжування, нормування скелета та обробку відсутніх кадрів
- **Пакетна обробка відео** — `batch_extractor.py` дозволяє обробляти цілі папки з відео використовуючи `extractor.py`.
- **Опрацювання датасетів** — `utils/dataset_windows.py` містить функції для побудови матриці суміжності для графа із 33 суглобів, генерації ковзних вікон, нормування координат навколо тазу, заміни відсутніх значень та застосування випадкових віддзеркалень чи шуму. Клас `PoseWindows` читає CSV із парами шлях,мітка та повертає вікна як тензори розміру `[C × T × J]` разом із мітками.
- **ST-GCN архітектура** — модуль `nn/stgcn.py` реалізує спатіо‑темпоральну графову згорткову мережу. Вона будуває матрицю суміжності для скелета з 33 вузлів та складає блоки графових згорток із часовими згортками, адаптивним пулінгом, дроп‑аутом та лінійним класифікатором
- **Навчання** — скрипт `train_classifier.py` навчає ST‑GCN на вашому датасеті. Він читає CSV із тренувальними та валідаційними даними, обчислює ваги класів, обробляє вибір GPU/CPU, використовує ранню зупинку на основі валідаційної втрати та зберігає найкращу модель 
- **Швидка класифікація** - `quick_classificator_from_trained_model.py` дзавантажує збережений чекпоінт та передбачає дії для нових послідовностей. Він підтримує голосування більшістю по ковзних вікнах та може читати назви класів із текстового файлу.
- **YouTube-тример** — `ytfinder.py` дозволяє завантажувати та обрізати відео для формування датасету.
- **Додаткові утиліти** — MP4-редактор `mp4slicer.py` - дозволяє швидко нарізати повне відео на фрагменти окремих вправ.

---

## Структура проєкту

| Каталог / файл | Опис |
|----------------|------|
| `mediapipe_layer/` | Екстракція поз, рендеринг, пакетна обробка |
| `nn/` | ST-GCN модель, навчання та інференс |
| `utils/` | Обробка датасету, генерація, порівняння, обрізання |
| `processed_data/` | Згенеровані `.npz` послідовності поз |
| `checkpoints/` | Збережені моделі |
| `out/` | Результати рендеру та прогнозування |
| `mp4slicer.py` | Тримінг відеофайлу |

---

## Встановлення

```bash
git clone https://github.com/ione-g/pose-detector.git
cd pose-detector
```
## Залежності

```bash
python3 or python -m venv venv
```
Активація на MacOS/Linux
```bash
source venv/bin/activate
```
Активація на віндовс
```bash
.\venv\Scripts\Activate.bat
```
```bash
pip install mediapipe opencv-python numpy pandas torch torchvision scikit-learn tqdm
```
також використання утиліти для нарізання відео (в даному репозиторії пропунується вже готові нарізки) потребує встановлення 
```bash
pip install yt-dlp ffmpeg-python PyQt5 dtw-python
sudo apt install ffmpeg
```
## Використання

### 1. Витягування поз із відео
Щоб перетворити відеофайл у .npz послідовність, запустіть:

```bash
python mediapipe_layer/extractor.py \
    --video path/to/input.mp4 \
    --out-prefix out/session1/pose \
    --model-complexity 2 \
    --use-world \
    --min-det 0.5 \
    --min-track 0.5 \
    --smooth-ema 0.75
```
Ця команда створить `pose.npz` із масивом розміру `(T,33,4)` та `pose.json` із метаданими Додаткові параметри: `--use-world`, `--no-center`, `--no-scale`, `--save-missing-as-nan`, `--render` та `--render-out`

Для пакетної обробки каталогу виконайте:
```bash
python mediapipe_layer/batch_extractor.py \
    --in-dir data_sets/squats \
    --out-dir out/squats \
    --model-complexity 2 \
    --use-world \
    --min-det 0.5 \
    --min-track 0.5 \
    --smooth-ema 0.75
```

### 2. Підготовка датасету
Після витягування `.npz` файлів створіть CSV з кожним шляхом та міткою, наприклад:

```bash
processed_data/session1/pose.npz,squat
processed_data/session2/pose.npz,push_up
```

Використовуйте `PoseWindows` із `utils/dataset_windows.py`, щоб завантажити послідовності, створити ковзні вікна, нормувати координати та застосувати аугментації. Скрипт навчання створює цей датасет автоматично.

### 3. Навчання мережі
Навчіть `ST‑GCN` з `nn/train_classifier.py` так:

```bash
python -m nn.train_classifier \
    --train-csv out/train.csv \
    --val-csv out/val.csv \
    --epochs 50 \
    --bs 32 \
    --lr 0.001 \
    --checkpoint-out checkpoints/stgcn_checkpoint.pth
```
Скрипт будує модель ST‑GCN із чотирьох блоків, обчислює ваги класів, навчає з ранньою зупинкою та зберігає найкращий чекпоінт

Для класифікації нових послідовностей використовуйте швидкий класифікатор:

```bash
python -m nn.quick_classificator_from_trained_model \
    --test-csv out/test.csv \
    --checkpoint checkpoints/stgcn_checkpoint.pth \
    --bs 32 
```



Запуск і відладка (поширені помилки)
-----------------------------------
- ModuleNotFoundError: No module named 'utils'
  - Запускайте скрипти з кореневої директорії проекту (`cd <project_root>`).
  - Або додайте `export PYTHONPATH=$(pwd)` перед запуском.

- ModuleNotFoundError: No module named '_tkinter' / `python -m tkinter` помилка
  - Інсталяція tcl-tk через Homebrew та перезбірка/перевстановлення Python:
    ```bash
    brew install tcl-tk
    brew reinstall python@3.11
    ```
  - Створіть знову venv після встановлення.

- HTTP 403 у `yt-dlp`:
  - Оновіть `yt-dlp` або спробуйте `--user-agent` опцію.
  - Деякі відео мають обмеження (приватні, регіональні, age-restricted).

- ffmpeg command not found:
  - Встановіть `ffmpeg` через Homebrew(для MacOS): `brew install ffmpeg`.
  - Встановіть [ffmpeg](https://www.gyan.dev/ffmpeg/builds/) із офіційного сайту, та додайте в PATH змінну для роботи cli `C:/FFMPEG_INSTALLATION_FOLDER/bin`